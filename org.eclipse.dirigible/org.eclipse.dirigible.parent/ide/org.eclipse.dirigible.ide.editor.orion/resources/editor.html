<!doctype html>
<html>
    <head>
        <meta name="copyright" content="Copyright (c) IBM Corporation and others 2010, 2014." >
        <meta http-equiv="Content-Language" content="en-us">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Pluggable Editor Demo</title>
        <link rel="stylesheet" type="text/css" href="code_edit/built-codeEdit.css"/>
        <style>
        body {
            overflow: hidden;
            height: 100%
        }
        #embeddedEditor {
            margin: 0;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
</style>
        <script src="requirejs/require.min.js"></script>
        <script>
// this needs to be in the global scope
editor = null;
breakpointsEnabled = false;

function createEditor(content, contentType, readOnlyStatus, breakpointsEnabledStatus, row) {
	setBreakpointsEnabled(breakpointsEnabledStatus);
	
    require(["code_edit/built-codeEdit", "orion/keyBinding"], function(widget, mKeyBinding) {
        var codeEdit = new widget();
        codeEdit.create({parent: "embeddedEditor", contentType: contentType, contents: content})
            .then(function(editorViewer) {
                editor = editorViewer.editor;
                var savedText = content;
                var isDirty = false;
                editor.getTextView().setKeyBinding(new mKeyBinding.KeyBinding("s", true), "save");
                editor.addEventListener("DirtyChanged", function(evt) {
                    var newText = editor.getText();
                    if (savedText !== newText && !isDirty) {
                        isDirty = true;
                        dirtyChanged(true);
                    } else if (savedText === newText && isDirty) {
                        isDirty = false;
                        dirtyChanged(false);
                    }
                });
                editorViewer.editor.getTextView().setAction("save", function(){ //$NON-NLS-0$
                    savedText = editor.getText();
                    isDirty = false;
                    saveCalled();
                    return true;
                });
                var ruler = editor._annotationRuler;
                var oldDblClick = ruler.onDblClick;
                var addRemoveBookmark = function(lineIndex, e) {
	                if(typeof(Storage) === "undefined") {
	                	alert("Session storage is not available!")
	                } else if (getBreakpointsEnabled()) {
                		var breakpointsArray;
	                	if (sessionStorage.breakpoints) {
	                		breakpointsArray = JSON.parse(sessionStorage.breakpoints)
	                		var index = breakpointsArray.indexOf(lineIndex);
	                		if (index > -1) {
	                			breakpointsArray.splice(index, 1);
	                		    clearBreakpoint(lineIndex);
	                		} else {
	                			breakpointsArray.push(lineIndex);
	                			setBreakpoint(lineIndex);
	                		}
	                	} else {
	                		breakpointsArray = [];
	                		breakpointsArray.push(lineIndex);
	                	    setBreakpoint(lineIndex);
	                	}
                	    sessionStorage.breakpoints = JSON.stringify(breakpointsArray);
	               		oldDblClick.apply(ruler, [lineIndex, e]);
	                }
                }
                ruler.onDblClick = addRemoveBookmark;
            });
    });
}

function setText(text, mode, readOnlyStatus, breakpointsEnabledStatus, row) {
    createEditor(text, mode, readOnlyStatus, breakpointsEnabledStatus, row);
}

function getText() {
    return editor.getText();
}

function setReadOnly(status) {
    editor.setReadOnly(status);
}

function getBreakpointsEnabled() {
    return breakpointsEnabled;
}

function setBreakpointsEnabled(status) {
	breakpointsEnabled = status;
}
</script>
    </head>
    <body id="orion-browser" spellcheck="false" class="orionPage">
        <div class="demoBody" id="embeddedEditor"></div>
    </body>
</html>
